<!DOCTYPE html>
<html lang="en">

<head>
    <title>Billiard Shot Viewer</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23fff'/><circle cx='50' cy='50' r='30' fill='%23000'/></svg>">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
        }

        #container {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-top: 20px;
            width: 852px;
            justify-content: center;
            gap: 10px;
        }

        #canvas-container {
            position: relative;
            width: 852px;
            height: 536px;
        }

        #canvas {
            border: 2px solid #333;
            background-color: #636ac9;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.5);
            position: absolute;
            /* Use top, left, width, and height to control canvas position and size */
            top: 44px;
            left: 28px;
            width: 740px;
            height: 370px;
            display: block;
            z-index: 1;
        }

        #myIframe {
            border: 1px solid #ccc;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.9;
            z-index: 2;
        }

        #controls {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            width: 100%;
            justify-content: center;
        }

        #controls button,
        #controls select,
        #controls input[type="file"] {
            margin-bottom: 0;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            min-width: 120px;
            flex-grow: 0;
            box-sizing: border-box;
        }

        #controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #shotIndexDisplay {
            margin: 0 10px;
            min-width: 80px;
        }

        footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
            width: 100%;
        }

        .topview {
  width: 800px;
  height: 460px;
}
    </style>
</head>

<body>

    <div id="canvas-container">
        <iframe id="myIframe"></iframe>
        <canvas id="canvas"></canvas>
        <div id="myIframe" class="replaydiagram">
            <div class="topview"
                data-state='?ruletype=threecushion&state={"init":[-0.8179,-0.2044,-0.8183,0,0.819,0],"shots":[{"type":"AIM","offset":{"x":-0.2683281572999748,"y":0.1341640786499874,"z":0},"angle":0.1499,"power":4.192,"pos":{"x":-0.8179000020027161,"y":-0.20440000295639038,"z":0},"i":0}]}'>
            </div>
        </div>
    </div>


    <div id="container">
        <div id="controls">
            <input type="file" id="fileInput">
            <span id="shotIndexDisplay">Shot: 1</span>
            <select id="shotSelector"></select>
        </div>
    </div>

    <div class="diagram">
        <p>
            Physical Constants <button id="replay" type="button">replay</button>
        </p>
        <br />
        <input id="R" type="range" />
        <label for="R">R</label>
        <input id="m" type="range" />
        <label for="m">m</label>
        <input id="e" type="range" />
        <label for="e">e</label>
        <input id="mu" type="range" />
        <label for="mu">mu</label>
        <input id="muS" type="range" />
        <label for="muS">muS</label>
        <input id="muC" type="range" />
        <label for="muC">muC</label>
        <input id="rho" type="range" />
        <label for="rho">rho</label>
    </div>

    <footer>
        Data source: <a href="https://www.youtube.com/c/NightCaféBilliard" style="color: #666;">Night Café Billiard</a>
        - Match between Cemal Cay and Ersin Dogan in December 2022
    </footer>
    
    <script>
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const shotIndexDisplay = document.getElementById('shotIndexDisplay');
        const shotSelector = document.getElementById('shotSelector');
        const myIframe = document.getElementById('myIframe');


        const BALL_COLORS = { 1: 'white', 2: 'yellow', 3: 'red' };
        const BALL_DIAMETER = 0.0615;
        const TABLE_WIDTH = 2.84;
        const TABLE_HEIGHT = TABLE_WIDTH / 2;
        const CUSHION_WIDTH = 0.01;
        const PIXELS_PER_METER = canvas.width / TABLE_WIDTH;

        let allShots = [];
        let currentShotIndex = 0;

        function updateUrlWithShot(shotId) {
            const url = new URL(window.location);
            url.searchParams.set('shot', shotId);
            console.log(shotId);
            window.history.pushState({}, '', url);
        }

        function getInitialShotFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('shot');
        }

        function loadDefaultData() {
            fetch('simple_shots.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    allShots = data;
                    if (allShots.length > 0) {
                        const urlShotId = getInitialShotFromUrl();
                        console.log("URL Shot ID:", urlShotId);
                        if (urlShotId) {
                            const shotIndex = allShots.findIndex(shot => shot.shotID == urlShotId);
                            console.log("Shot index:", shotIndex);
                            currentShotIndex = shotIndex >= 0 ? shotIndex : 0;
                        } else {
                            currentShotIndex = 0;
                        }
                        populateShotSelector();
                        updateDisplay();
                        drawShot(allShots[currentShotIndex]);
                    } else {
                        console.log("No shots found in the default JSON file.");
                    }
                })
                .catch(error => {
                    console.error("Error loading default JSON:", error);
                });
        }

        window.addEventListener('load', loadDefaultData);


        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        allShots = JSON.parse(e.target.result);
                        if (allShots.length > 0) {
                            currentShotIndex = 0;
                            populateShotSelector();
                            updateDisplay();
                            drawShot(allShots[currentShotIndex]);
                        } else {
                            alert("No shots found in the JSON file.");
                        }
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                        alert("Error parsing JSON file.");
                    }
                };
                reader.readAsText(file);
            }
        });

        function populateShotSelector() {
            shotSelector.innerHTML = '';
            allShots.forEach((shot, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.text = `Shot ${index + 1} (ID: ${shot.shotID})`;
                shotSelector.add(option);
            });
        }

        function updateDisplay() {
            shotIndexDisplay.textContent = `Shot: ${currentShotIndex + 1}`;
            if (allShots[currentShotIndex]) {
                shotSelector.value = currentShotIndex;
            }
        }

        function drawShot(shotData) {
            ctx.scale(-1, -1);
            ctx.translate(-canvas.width, -canvas.height);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#222255';
            ctx.fillRect(0, 0, canvas.width, CUSHION_WIDTH * PIXELS_PER_METER);
            ctx.fillRect(0, canvas.height - CUSHION_WIDTH * PIXELS_PER_METER, canvas.width, CUSHION_WIDTH * PIXELS_PER_METER);
            ctx.fillRect(0, 0, CUSHION_WIDTH * PIXELS_PER_METER, canvas.height);
            ctx.fillRect(canvas.width - CUSHION_WIDTH * PIXELS_PER_METER, 0, CUSHION_WIDTH * PIXELS_PER_METER, canvas.height);

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;

            for (let i = 0; i <= 8; i++) {
                let x = CUSHION_WIDTH * PIXELS_PER_METER + (i * (canvas.width - 2 * CUSHION_WIDTH * PIXELS_PER_METER) / 8);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            for (let i = 0; i <= 4; i++) {
                let y = CUSHION_WIDTH * PIXELS_PER_METER + (i * (canvas.height - 2 * CUSHION_WIDTH * PIXELS_PER_METER) / 4);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            for (const ballNum in shotData.balls) {
                const ballData = shotData.balls[ballNum];
                const color = BALL_COLORS[ballNum];

                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < ballData.x.length; i++) {
                    const x = ballData.x[i] * PIXELS_PER_METER;
                    const y = ballData.y[i] * PIXELS_PER_METER;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                if (ballData.x.length > 0) {
                    const initialX = ballData.x[0] * PIXELS_PER_METER;
                    const initialY = ballData.y[0] * PIXELS_PER_METER;
                    const radius = BALL_DIAMETER / 2 * PIXELS_PER_METER

                    ctx.beginPath();
                    ctx.arc(initialX, initialY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }
        }

        shotSelector.addEventListener('change', () => {
            currentShotIndex = parseInt(shotSelector.value, 10);
            updateDisplay();
            drawShot(allShots[currentShotIndex]);
            updateUrlWithShot(allShots[currentShotIndex].shotID);
        });

//        loadIframe();

        function loadIframe() {
            const state = {
                init: [-0.8179000020027161, -0.20440000295639038, -0.8183000087738037, 0, 0.8190000057220459, 0],
                shots: [{
                    type: "AIM",
                    offset: { x: -0.2683281572999748, y: 0.1341640786499874, z: 0 },
                    angle: 0.152,
                    power: 4.192,
                    pos: { x: -0.8179000020027161, y: -0.20440000295639038, z: 0 },
                    i: 0
                }]
            };

            const stateParam = encodeURIComponent(JSON.stringify(state));
            const targetUrl = `https://tailuge.github.io/billiards/dist/?ruletype=threecushion&state=${stateParam}`;

            myIframe.src = targetUrl;
        }
    </script>

    <script src="../vendor.js"></script>
    <script src="../diagram.js"></script>

</body>

</html>